name: Sync Upstream (Daily Rotating, auto-detect branch)

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch:

concurrency:
  group: sync-upstream-${{ github.repository }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

env:
  TARGET_BRANCH: main
  # REPO_LIST entries supports "owner/repo" or "owner/repo:branch"
  REPO_LIST: |
    igcyukira/i0c.cc
    astrbotdevs/astrbot:master
    microsoft/vscode
    torvalds/linux
    facebook/react
    kelseyhightower/nocode
    jdan/98.css
    excalidraw/excalidraw
    kamranahmedse/developer-roadmap
    jezen/is-thirteen
    trekhleb/javascript-algorithms
    donnemartin/system-design-primer
    mrdoob/three.js
    animate-css/animate.css
    airbnb/javascript
    public-apis/public-apis
    # --- ğŸ›ï¸ å†å²ä¸æå®¢åœ£ç» (é•‡å®…ä¸“ç”¨) ---
    chrislgarry/Apollo-11        # é˜¿æ³¢ç½—11å·ç™»æœˆä»£ç  (æ±‡ç¼–è¯­è¨€ï¼Œç¡¬æ ¸ï¼)
    id-Software/DOOM             # æ¯ç­æˆ˜å£« (DOOM) æºç  (æ¸¸æˆç•Œçš„ä¼ å¥‡)
    bitcoin/bitcoin              # æ¯”ç‰¹å¸æºç  (è¿™å°±æ˜¯èµ›åšé»„é‡‘ï¼)
    git/git                      # Git è‡ªå·±çš„æºç  (æˆ‘ å˜ æˆ‘ è‡ª å·±)
    
    # --- ğŸ¤£ ç¨‹åºå‘˜çš„é»‘è‰²å¹½é»˜ (ä¸€çœ‹å°±æ‡‚) ---
    nvbn/thefuck                 # è¾“é”™å‘½ä»¤æ—¶è‡ªåŠ¨çº æ­£çš„ç¥å™¨ (åå­—å¾ˆæš´èºï¼ŒåŠŸèƒ½å¾ˆæš–å¿ƒ)
    denysdovhan/wtfjs            # JS é‡Œçš„å„ç§å¥‡è‘©ç‰¹æ€§ (ä¸€è¾¹çœ‹ä¸€è¾¹æ€€ç–‘äººç”Ÿ)
    EbookFoundation/free-programming-books # å²ä¸Š Star æœ€å¤šçš„ä»“åº“ (å…¨æ˜¯ä¹¦)
    996icu/996.ICU               # (æ‡‚çš„éƒ½æ‡‚ï¼Œç¨‹åºå‘˜é˜²èº«æœ¯)
    
    # --- ğŸ¨ è§†è§‰ä¸å¥½ç©çš„å‰ç«¯ ---
    mrdoob/three.js              # 3D åº“ï¼Œä»£ç é‡Œå…¨æ˜¯é­”æ³•
    d3/d3                        # æ•°æ®å¯è§†åŒ–ï¼Œçœ‹ç€å¾ˆé«˜çº§
    goldbergyoni/nodebestpractices # Node.js æœ€ä½³å®è·µ (å‡è£…è‡ªå·±åœ¨åŠªåŠ›å­¦ä¹ )
    
    # --- ğŸˆ å¥‡å¥‡æ€ªæ€ªçš„å¯çˆ±ä¸œè¥¿ ---
    sindresorhus/awesome         # å„ç§â€œAwesomeâ€åˆ—è¡¨çš„ç¥–å®—
    ruanyf/weekly                # é˜®ä¸€å³°çš„æŠ€æœ¯å‘¨åˆŠ (å¾ˆæœ‰æ–‡åŒ–æ°”æ¯)
    getify/You-Dont-Know-JS      # ä½ ä¸çŸ¥é“çš„ JS (ç»å…¸æ•™ç¨‹)
    
  # PAT must be stored in repository secrets as PAT with repo read & write permissions
  PAT: ${{ secrets.PAT }}

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target branch (full history)
        uses: actions/checkout@v6
        with:
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Ensure git user and install deps
        run: |
          git config --global user.name 'IGCrystal-G'
          git config --global user.email 'cacheigcrystal@gmail.com'
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Choose upstream repo of the day and sync (auto-detect branch)
        env:
          PAT: ${{ secrets.PAT }}
          REPO_LIST: ${{ env.REPO_LIST }}
          TARGET_BRANCH: ${{ env.TARGET_BRANCH }}
        run: |
          set -euxo pipefail

          # parse repo list
          # ä½¿ç”¨ grep -v è¿‡æ»¤æ‰çº¯æ³¨é‡Šè¡Œå’Œç©ºè¡Œ
          mapfile -t REPOS < <(echo "$REPO_LIST" | grep -v '^\s*#' | grep -v '^\s*$')
          
          COUNT=${#REPOS[@]}
          if [ "$COUNT" -eq 0 ]; then
            echo "REPO_LIST is empty; nothing to do."
            exit 1
          fi

          # pick rotating index based on epoch days (changes every day)
          DAY=$(( $(date -u +%s) / 86400 ))
          IDX=$(( DAY % COUNT ))
          RAW_ENTRY="${REPOS[$IDX]}"
          
          ENTRY=$(echo "${RAW_ENTRY%%#*}" | xargs)
          
          echo "Selected entry (cleaned): '$ENTRY' (from raw: '$RAW_ENTRY')"

          # support optional ":branch" suffix
          if [[ "$ENTRY" == *":"* ]]; then
            UPSTREAM_REPO="${ENTRY%%:*}"
            UPSTREAM_BRANCH="${ENTRY##*:}"
            echo "Using explicit branch: ${UPSTREAM_BRANCH} for ${UPSTREAM_REPO}"
          else
            UPSTREAM_REPO="$ENTRY"
            # query repository to get default branch via GitHub API (requires PAT)
            API_URL="https://api.github.com/repos/${UPSTREAM_REPO}"
            echo "Detecting default branch for ${UPSTREAM_REPO} via GitHub API..."
            
            # å¢åŠ  -f å‚æ•°ï¼Œå¦‚æœ API æŠ¥é”™ç›´æ¥å¤±è´¥ï¼Œä¸è®© jq è§£æé”™è¯¯ä¿¡æ¯
            RESPONSE=$(curl -s -f -H "Authorization: token ${PAT}" -H "Accept: application/vnd.github+json" "${API_URL}" || echo "")
            
            if [ -n "$RESPONSE" ]; then
                DEFAULT_BRANCH=$(echo "$RESPONSE" | jq -r '.default_branch // empty')
            else
                DEFAULT_BRANCH=""
            fi

            if [ -z "$DEFAULT_BRANCH" ] || [ "$DEFAULT_BRANCH" = "null" ]; then
              echo "âš ï¸ Failed to detect default branch via API (maybe 404 or limit), falling back to 'main'"
              UPSTREAM_BRANCH="main"
            else
              UPSTREAM_BRANCH="$DEFAULT_BRANCH"
            fi
            echo "Detected upstream branch: ${UPSTREAM_BRANCH}"
          fi

          # add upstream remote (fresh)
          git remote remove upstream || true
          git remote add upstream "https://github.com/${UPSTREAM_REPO}.git"

          # fetch that branch (full fetch)
          git fetch upstream "${UPSTREAM_BRANCH}" || { echo "fetch upstream ${UPSTREAM_BRANCH} failed"; exit 1; }

          # quick exit if upstream already merged into HEAD
          if git merge-base --is-ancestor "upstream/${UPSTREAM_BRANCH}" HEAD 2>/dev/null; then
            echo "Upstream already merged into HEAD â€” nothing to do."
            exit 0
          fi

          # preserve local workflow file content so we can restore it after merge
          PRESERVE_DIR="$(mktemp -d)"
          mkdir -p "$PRESERVE_DIR"
          if git show HEAD:.github/workflows/sync-upstream.yml > "$PRESERVE_DIR/sync-upstream.yml" 2>/dev/null; then
            echo "Preserved current workflow file."
          else
            mkdir -p .github/workflows || true
            if [ -f .github/workflows/sync-upstream.yml ]; then
              cp .github/workflows/sync-upstream.yml "$PRESERVE_DIR/sync-upstream.yml"
            else
              printf '%s\n' "# preserved placeholder" > "$PRESERVE_DIR/sync-upstream.yml"
            fi
          fi

          # Attempt a merge without committing to detect conflicts
          if git merge --no-commit --no-ff --allow-unrelated-histories "upstream/${UPSTREAM_BRANCH}"; then
            git commit -m "chore: sync upstream ${UPSTREAM_REPO}@${UPSTREAM_BRANCH} into ${TARGET_BRANCH}"

            # restore our workflow file to ensure this workflow stays intact
            cp "$PRESERVE_DIR/sync-upstream.yml" .github/workflows/sync-upstream.yml || true
            if ! git diff --quiet -- .github/workflows/sync-upstream.yml; then
              git add .github/workflows/sync-upstream.yml
              git commit -m "chore: preserve local workflow file after merging ${UPSTREAM_REPO}" || true
            fi

            # cleanup git objects
            git repack -a -d || true
            git gc --prune=now --aggressive || true

            # push directly to target branch (main). retry a few times on transient errors.
            PUSH_ATTEMPTS=0
            until [ "$PUSH_ATTEMPTS" -ge 5 ]; do
              git push origin "HEAD:${TARGET_BRANCH}" && break
              PUSH_ATTEMPTS=$((PUSH_ATTEMPTS+1))
              echo "Push attempt $PUSH_ATTEMPTS failed, retrying in 5s..."
              sleep 5
            done
            if [ "$PUSH_ATTEMPTS" -ge 5 ]; then
              echo "Direct push failed after multiple attempts; creating a PR branch as fallback."
              BRANCH_NAME="sync-upstream-$(date +%Y%m%d-%H%M%S)"
              git checkout -b "$BRANCH_NAME"
              git push --set-upstream origin "$BRANCH_NAME"
              API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}"
              OWNER=${GITHUB_REPOSITORY%%/*}
              CREATE_PR_RESP=$(curl -s -X POST \
                -H "Authorization: token ${PAT}" \
                -H "Accept: application/vnd.github+json" \
                "${API_URL}/pulls" \
                -d "{\"title\":\"chore: sync upstream ${UPSTREAM_REPO}\",\"head\":\"${OWNER}:${BRANCH_NAME}\",\"base\":\"${TARGET_BRANCH}\",\"body\":\"Auto sync from upstream ${UPSTREAM_REPO} â€” push failed, please review and merge.\"}")
              echo "Created PR fallback: $CREATE_PR_RESP"
              exit 0
            fi

            echo "Merged upstream ${UPSTREAM_REPO}@${UPSTREAM_BRANCH} and pushed to ${TARGET_BRANCH}."
            exit 0

          else
            # merge had conflicts. abort and create a conflict branch + PR
            echo "Merge produced conflicts. Aborting merge and opening PR for manual resolution."
            git merge --abort || true

            BRANCH_NAME="sync-upstream-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH_NAME"

            # attempt a merge on the new branch to carry conflict markers for review
            git merge --no-edit --allow-unrelated-histories "upstream/${UPSTREAM_BRANCH}" || true

            # restore preserved workflow to avoid replacing it with upstream's
            cp "$PRESERVE_DIR/sync-upstream.yml" .github/workflows/sync-upstream.yml || true
            git add .github/workflows/sync-upstream.yml || true
            git commit -m "chore: preserve workflow file (conflict branch for ${UPSTREAM_REPO})" || true

            # repack/gc
            git repack -a -d || true
            git gc --prune=now --aggressive || true

            # push conflict branch
            git push --set-upstream origin "$BRANCH_NAME"

            # create PR for manual conflict resolution
            API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}"
            OWNER=${GITHUB_REPOSITORY%%/*}
            CREATE_PR_RESP=$(curl -s -X POST \
              -H "Authorization: token ${PAT}" \
              -H "Accept: application/vnd.github+json" \
              "${API_URL}/pulls" \
              -d "{\"title\":\"chore: sync upstream ${UPSTREAM_REPO} (conflicts)\",\"head\":\"${OWNER}:${BRANCH_NAME}\",\"base\":\"${TARGET_BRANCH}\",\"body\":\"Automatic sync from ${UPSTREAM_REPO}@${UPSTREAM_BRANCH} resulted in conflicts. Please resolve the conflicts in branch ${BRANCH_NAME}.\"}")

            echo "Created PR for conflict resolution: $CREATE_PR_RESP"
            exit 0
          fi
