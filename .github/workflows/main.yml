name: Daily Roulette (Shapeshifter) ğŸ²

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  # ğŸ“ è¿™é‡Œæ”¾å¤§åå•
  REPO_LIST: |
    igcyukira/i0c.cc
    astrbotdevs/astrbot:master
    microsoft/vscode
    torvalds/linux
    facebook/react
    kelseyhightower/nocode
    jdan/98.css
    excalidraw/excalidraw
    kamranahmedse/developer-roadmap
    jezen/is-thirteen
    trekhleb/javascript-algorithms
    donnemartin/system-design-primer
    mrdoob/three.js
    animate-css/animate.css
    airbnb/javascript
    public-apis/public-apis
    # --- ğŸ›ï¸ å†å²ä¸æå®¢åœ£ç» ---
    chrislgarry/Apollo-11
    id-Software/DOOM
    bitcoin/bitcoin
    git/git
    # --- ğŸ¤£ é»‘è‰²å¹½é»˜ ---
    nvbn/thefuck
    denysdovhan/wtfjs
    EbookFoundation/free-programming-books
    996icu/996.ICU
    # --- ğŸ¨ å‰ç«¯ ---
    mrdoob/three.js
    d3/d3
    goldbergyoni/nodebestpractices
    # --- ğŸˆ å¥‡å¥‡æ€ªæ€ª ---
    sindresorhus/awesome
    ruanyf/weekly
    getify/You-Dont-Know-JS

jobs:
  shapeshift:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout self
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.PAT }}
          fetch-depth: 0

      - name: Setup Git User
        run: |
          git config --global user.name 'Ditto-Bot'
          git config --global user.email 'ditto@pokemon.com'

      - name: Roll the Dice & Transform ğŸ²
        env:
          PAT: ${{ secrets.PAT }}
        run: |
          # 1. è§£æåˆ—è¡¨ (å¸¦æ¸…æ´—)
          mapfile -t REPOS < <(echo "${{ env.REPO_LIST }}" | grep -v '^\s*#' | grep -v '^\s*$')
          
          SIZE=${#REPOS[@]}
          if [ "$SIZE" -eq 0 ]; then
            echo "âŒ Repo list is empty!"
            exit 1
          fi

          # 2. éšæœºæŠ½é€‰
          DAY=$(( $(date -u +%s) / 86400 ))
          INDEX=$(( DAY % SIZE ))
          RAW_ENTRY="${REPOS[$INDEX]}"
          ENTRY=$(echo "${RAW_ENTRY%%#*}" | xargs)
          
          echo "ğŸ° Dice rolled: $INDEX / $SIZE"
          echo "ğŸ¯ Today's Target: $ENTRY"

          # å¤„ç†åˆ†æ”¯åç¼€ (repo:branch)
          if [[ "$ENTRY" == *":"* ]]; then
            TARGET_REPO="${ENTRY%%:*}"
            TARGET_BRANCH="${ENTRY##*:}"
          else
            TARGET_REPO="$ENTRY"
            TARGET_BRANCH="" 
          fi

          # -------------------------------------------------------
          # 3. ğŸ’¥ æ‹†è¿åŠè¿›åœº (é™¤äº† .git å’Œ .github å…¨åˆ æ‰ï¼)
          # -------------------------------------------------------
          echo "ğŸ’¥ Clearing current files..."
          # è¿™ä¸€æ­¥ä¿è¯äº†ä¸ä¼šå‡ºç° Merge Conflictï¼Œå› ä¸ºæˆ‘ä»¬æŠŠæ—§å®¶æ‹†äº†ï¼
          find . -maxdepth 1 ! -name '.git' ! -name '.github' ! -name '.' -exec rm -rf {} +

          # -------------------------------------------------------
          # 4. ğŸ“¥ å·å¤©æ¢æ—¥ (Clone åˆ«äººçš„ä»£ç )
          # -------------------------------------------------------
          echo "ğŸ“¥ Cloning $TARGET_REPO..."
          
          if [ -n "$TARGET_BRANCH" ]; then
            git clone --depth 1 -b "$TARGET_BRANCH" "https://github.com/$TARGET_REPO.git" temp_clone
          else
            git clone --depth 1 "https://github.com/$TARGET_REPO.git" temp_clone
          fi

          # 5. æ¬è¿
          shopt -s dotglob
          rm -rf temp_clone/.git    # æ‰”æ‰å¯¹æ–¹çš„å†å²
          rm -rf temp_clone/.github # æ‰”æ‰å¯¹æ–¹çš„ Action (é˜²æ­¢å†²çª)

          # æŠŠå¯¹æ–¹çš„ä¸œè¥¿æ¬åˆ°æˆ‘ä»¬å®¶
          mv temp_clone/* . || echo "Target repo might be empty."
          rm -rf temp_clone

          # -------------------------------------------------------
          # 6. ğŸ“ æäº¤å˜èº«ç»“æœ
          # -------------------------------------------------------
          git add .
          DATE=$(date +%Y-%m-%d)
          
          # æäº¤ï¼
          git commit -m "ğŸ­ Shapeshift into: $TARGET_REPO ($DATE)" || echo "No changes (Same repo again?)"
          
          # 7. ğŸš€ å¼ºæ¨ (è¦†ç›–æ˜¨å¤©çš„ä¸»åˆ†æ”¯)
          git push
